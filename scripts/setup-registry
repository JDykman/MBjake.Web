#!/bin/bash
set -e

# Setup Podman Port Registry
# Standalone script that checks if the port registry is initialized and creates it if needed.
# This script can be used after the template setup process is complete.

VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Registry location
REGISTRY_DIR="${PODMAN_PORT_REGISTRY_DIR:-${HOME}/.local/share/podman-ports}"
REGISTRY_FILE="$REGISTRY_DIR/registry.json"

echo "========================================"
echo "Podman Port Registry Setup"
echo "========================================"
echo ""

# Check if jq is installed (required for registry operations)
if ! command -v jq &> /dev/null; then
    echo -e "${YELLOW}Warning: jq is required for port registry operations${NC}"
    echo ""
    echo "Install jq:"
    echo "  Ubuntu/Debian: sudo apt-get install jq"
    echo "  RHEL/Fedora:   sudo dnf install jq"
    echo "  macOS:         brew install jq"
    echo ""
    echo "Please install jq and run this script again."
    exit 1
fi

# Check if registry is already initialized
if [ -f "$REGISTRY_FILE" ]; then
    echo -e "${GREEN}✓ Port registry is already initialized${NC}"
    echo ""
    echo "Registry location: $REGISTRY_FILE"
    echo ""
    
    PORT_COUNT=$(jq '.ports | length' "$REGISTRY_FILE" 2>/dev/null || echo "0")
    echo "Current status:"
    echo "  - Reserved ports: $PORT_COUNT"
    echo ""
    
    if [ "$PORT_COUNT" -gt 0 ]; then
        echo "Reserved ports:"
        jq -r '.ports | to_entries[] | "  - Port \(.key): \(.value.project)-\(.value.environment)"' "$REGISTRY_FILE" 2>/dev/null || true
        echo ""
    fi
    
    echo "The registry is ready to use."
    exit 0
fi

# Initialize the registry
echo -e "${BLUE}Port registry not found. Initializing...${NC}"
echo ""

# Create registry directory
mkdir -p "$REGISTRY_DIR"

# Create initial registry file
cat > "$REGISTRY_FILE" << EOF
{
  "ports": {},
  "metadata": {
    "version": "$VERSION",
    "created": "$(date -Iseconds)"
  }
}
EOF

if [ -f "$REGISTRY_FILE" ]; then
    echo -e "${GREEN}✓ Port registry initialized successfully${NC}"
    echo ""
    echo "Registry location: $REGISTRY_FILE"
    echo ""
    echo "The registry is now ready to track port allocations across your projects."
    echo ""
    echo "Note: The port registry is used by the podman deployment scripts to"
    echo "      prevent port conflicts when running multiple projects."
else
    echo -e "${RED}Error: Failed to create registry file${NC}"
    exit 1
fi

